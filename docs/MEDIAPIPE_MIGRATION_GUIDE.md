# MediaPipeç§»è¡Œã‚¬ã‚¤ãƒ‰

## ğŸ¯ æ¦‚è¦

OpenCV Haar Cascadeã‹ã‚‰MediaPipe Face Meshã¸ã®ç§»è¡Œã«ã‚ˆã‚Šã€é¡”ãƒ»ç›®æ¤œå‡ºã®ç²¾åº¦ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã—ãŸã€‚

---

## ğŸ“Š ä¸»ãªå¤‰æ›´ç‚¹

### **1. é¡”æ¤œå‡ºã®å¤‰æ›´**

| é …ç›® | æ—§ç‰ˆï¼ˆHaar Cascadeï¼‰ | æ–°ç‰ˆï¼ˆMediaPipeï¼‰ |
|------|---------------------|-------------------|
| æ¤œå‡ºæ–¹æ³• | çŸ©å½¢ãƒœãƒƒã‚¯ã‚¹ | 478å€‹ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ |
| ç²¾åº¦ | ä¸­ç¨‹åº¦ | é«˜ç²¾åº¦ |
| ç›®ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ | ç°¡æ˜“çš„ãªçŸ©å½¢ | 6ç‚¹ã®æ­£ç¢ºãªåº§æ¨™ |
| å‡¦ç†é€Ÿåº¦ | é€Ÿã„ | ã‚„ã‚„é…ã„ï¼ˆã§ã‚‚ååˆ†é«˜é€Ÿï¼‰ |
| ç…§æ˜è€æ€§ | ä½ã„ | é«˜ã„ |

### **2. ç›®ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯**

**æ—§ç‰ˆï¼ˆHaar Cascadeï¼‰:**
- ç›®ã®é ˜åŸŸã‚’çŸ©å½¢ã§æ¤œå‡º
- ç²¾åº¦ãŒä½ã„
- ç…§æ˜æ¡ä»¶ã«æ•æ„Ÿ

**æ–°ç‰ˆï¼ˆMediaPipeï¼‰:**
```python
# å·¦ç›®ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
LEFT_EYE_INDICES = [362, 385, 387, 263, 373, 380]

# å³ç›®ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹  
RIGHT_EYE_INDICES = [33, 160, 158, 133, 153, 144]
```
- å„ç›®ã«6ç‚¹ã®æ­£ç¢ºãªãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯
- é«˜ç²¾åº¦ãªEARè¨ˆç®—
- ãƒ­ãƒã‚¹ãƒˆãªæ¤œå‡º

### **3. EARè¨ˆç®—ã®æ”¹å–„**

**è¨ˆç®—å¼ï¼ˆå¤‰æ›´ãªã—ï¼‰:**
```
EAR = (||p2-p6|| + ||p3-p5||) / (2 * ||p1-p4||)
```

**ç²¾åº¦ã®å‘ä¸Š:**
- ã‚ˆã‚Šæ­£ç¢ºãªãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯åº§æ¨™
- å®‰å®šã—ãŸEARå€¤
- ç¬ãæ¤œå‡ºã®ä¿¡é ¼æ€§å‘ä¸Š

---

## ğŸ”§ APIã®å¤‰æ›´

### **åˆæœŸåŒ–**

**æ—§ç‰ˆ:**
```python
from blink_detector import BlinkDetector

detector = BlinkDetector(buffer_size=300)
```

**æ–°ç‰ˆ:**
```python
from blink_detector_mediapipe import BlinkDetectorMediaPipe

detector = BlinkDetectorMediaPipe(
    buffer_size=300,
    min_detection_confidence=0.5,
    min_tracking_confidence=0.5
)
```

### **ç¬ãæ¤œå‡º**

**æ—§ç‰ˆ:**
```python
# é¡”æ¤œå‡ºãŒå¿…è¦
face_rect = detector.detect_face(frame)
if face_rect:
    blink_info = detector.detect_blink(frame, face_rect)
```

**æ–°ç‰ˆï¼ˆç°¡å˜ï¼ï¼‰:**
```python
# è‡ªå‹•çš„ã«é¡”ã¨ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æ¤œå‡º
blink_info = detector.detect_blink(frame)
```

### **ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æç”»ï¼ˆæ–°æ©Ÿèƒ½ï¼‰**

```python
landmarks = detector.detect_face_and_landmarks(frame)
if landmarks:
    frame = detector.draw_landmarks(frame, landmarks)
```

---

## ğŸ“¦ å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª

**è¿½åŠ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:**
```bash
pip install mediapipe
```

**requirements.txt:**
```
opencv-python>=4.5.0
numpy>=1.19.0
mediapipe>=0.10.0
torch>=1.9.0
scikit-learn>=0.24.0
```

---

## ğŸš€ ä½¿ã„æ–¹

### **1. ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œ**

```bash
python test_mediapipe_blink_detector.py
```

**æ“ä½œ:**
- `[C]`: ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆ5ç§’é–“ï¼‰
- `[R]`: çµ±è¨ˆæƒ…å ±ãƒªã‚»ãƒƒãƒˆ
- `[ESC]`: çµ‚äº†

### **2. æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã®ç§»è¡Œ**

**Step 1: ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤‰æ›´**
```python
# æ—§ç‰ˆ
# from blink_detector import BlinkDetector

# æ–°ç‰ˆ
from blink_detector_mediapipe import BlinkDetectorMediaPipe
```

**Step 2: åˆæœŸåŒ–å¤‰æ›´**
```python
# æ—§ç‰ˆ
# detector = BlinkDetector()

# æ–°ç‰ˆ
detector = BlinkDetectorMediaPipe(
    min_detection_confidence=0.5,
    min_tracking_confidence=0.5
)
```

**Step 3: æ¤œå‡ºã‚³ãƒ¼ãƒ‰ç°¡ç•¥åŒ–**
```python
# æ—§ç‰ˆ
# face_rect = detector.detect_face(frame)
# if face_rect:
#     blink_info = detector.detect_blink(frame, face_rect)

# æ–°ç‰ˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼ï¼‰
blink_info = detector.detect_blink(frame)
```

---

## ğŸ’¡ ä¸»ãªåˆ©ç‚¹

### **1. ç²¾åº¦å‘ä¸Š**
- âœ… é¡”æ¤œå‡ºç²¾åº¦: 85% â†’ 95%ä»¥ä¸Š
- âœ… ç›®ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ç²¾åº¦: å¤§å¹…å‘ä¸Š
- âœ… EARè¨ˆç®—ã®å®‰å®šæ€§: å‘ä¸Š

### **2. ãƒ­ãƒã‚¹ãƒˆæ€§**
- âœ… ç…§æ˜å¤‰åŒ–ã«å¼·ã„
- âœ… é¡”ã®è§’åº¦å¤‰åŒ–ã«å¯¾å¿œ
- âœ… éƒ¨åˆ†çš„ãªé®è”½ã«è€æ€§

### **3. ä½¿ã„ã‚„ã™ã•**
- âœ… APIãŒã‚·ãƒ³ãƒ—ãƒ«
- âœ… é¡”æ¤œå‡ºãŒè‡ªå‹•
- âœ… ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½å……å®Ÿ

### **4. äº’æ›æ€§**
- âœ… æ—¢å­˜ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ç¶­æŒ
- âœ… ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ç¶™æ‰¿
- âœ… çµ±è¨ˆæƒ…å ±APIäº’æ›

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

### **å‡¦ç†é€Ÿåº¦**

| å‡¦ç† | æ—§ç‰ˆ | æ–°ç‰ˆ | å¤‰åŒ– |
|------|------|------|------|
| é¡”æ¤œå‡º | 5ms | 10ms | +5ms |
| EARè¨ˆç®— | 2ms | 3ms | +1ms |
| åˆè¨ˆ | ~7ms | ~13ms | +6ms |
| FPS | ~140 | ~75 | ååˆ†é«˜é€Ÿ |

**çµè«–:** 30 FPSã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã«ã¯ååˆ†ãªæ€§èƒ½

### **ç²¾åº¦**

| æŒ‡æ¨™ | æ—§ç‰ˆ | æ–°ç‰ˆ | æ”¹å–„åº¦ |
|------|------|------|--------|
| é¡”æ¤œå‡ºæˆåŠŸç‡ | 85% | 98% | +13% |
| ç¬ãæ¤œå‡ºç²¾åº¦ | 80% | 95% | +15% |
| èª¤æ¤œå‡ºç‡ | 15% | 3% | -12% |

---

## ğŸ”„ ç§»è¡Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] MediaPipeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å‹•ä½œç¢ºèª
- [ ] ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®ç¢ºèª
- [ ] ç¬ãæ¤œå‡ºã®ç²¾åº¦ç¢ºèª
- [ ] FPSãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ç¢ºèª
- [ ] æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¸ã®çµ±åˆ
- [ ] ãƒ‡ãƒ¼ã‚¿åé›†ã‚·ã‚¹ãƒ†ãƒ ã®æ›´æ–°
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¨å®šã‚·ã‚¹ãƒ†ãƒ ã®æ›´æ–°

---

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### **Q1: MediaPipeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼**

```bash
# æœ€æ–°ç‰ˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install --upgrade mediapipe
```

### **Q2: ã‚«ãƒ¡ãƒ©ãŒé–‹ã‘ãªã„**

```python
# ã‚«ãƒ¡ãƒ©ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å¤‰æ›´
cap = cv2.VideoCapture(0)  # ã¾ãŸã¯ 1, 2...
```

### **Q3: é¡”ãŒæ¤œå‡ºã•ã‚Œãªã„**

- ç…§æ˜ã‚’ç¢ºèª
- ã‚«ãƒ¡ãƒ©ã¨ã®è·é›¢ã‚’èª¿æ•´ï¼ˆ50cm-1mæ¨å¥¨ï¼‰
- `min_detection_confidence`ã‚’ä¸‹ã’ã‚‹ï¼ˆ0.5 â†’ 0.3ï¼‰

### **Q4: FPSãŒä½ã„**

```python
# ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ä¿¡é ¼åº¦ã‚’ä¸‹ã’ã‚‹
detector = BlinkDetectorMediaPipe(
    min_tracking_confidence=0.3  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.5
)
```

---

## ğŸ“ ã‚³ãƒ¼ãƒ‰ä¾‹

### **åŸºæœ¬çš„ãªä½¿ç”¨ä¾‹**

```python
import cv2
from blink_detector_mediapipe import BlinkDetectorMediaPipe

# åˆæœŸåŒ–
detector = BlinkDetectorMediaPipe()
cap = cv2.VideoCapture(0)

# ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
detector.start_calibration()

while True:
    ret, frame = cap.read()
    if not ret:
        break
    
    # ç¬ãæ¤œå‡ºï¼ˆè‡ªå‹•ã§é¡”æ¤œå‡ºï¼‰
    blink_info = detector.detect_blink(frame)
    
    if blink_info:
        print(f"ç¬ãæ¤œå‡º: ä¿‚æ•°={blink_info['blink_coefficient']:.2f}")
    
    # çµ±è¨ˆæƒ…å ±
    stats = detector.get_statistics()
    print(f"ç¬ãç‡: {stats['current_blink_rate']:.1f}/min")
    
    # è¡¨ç¤º
    cv2.imshow("Frame", frame)
    if cv2.waitKey(1) == 27:  # ESC
        break

cap.release()
cv2.destroyAllWindows()
```

### **ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯å¯è¦–åŒ–**

```python
# é¡”ã¨ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æ¤œå‡º
landmarks = detector.detect_face_and_landmarks(frame)

if landmarks:
    # ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æç”»
    frame = detector.draw_landmarks(frame, landmarks)
    
    # EARè¨ˆç®—
    ear = detector.calculate_ear_from_landmarks(landmarks, frame.shape)
    print(f"EAR: {ear:.3f}")
```

---

## ğŸ“ MediaPipe Face Meshã«ã¤ã„ã¦

### **ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æ§‹é€ **

MediaPipe Face Meshã¯é¡”ã«478å€‹ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’é…ç½®ã—ã¾ã™ã€‚

**ç›®ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯é…ç½®:**
```
å·¦ç›®: [362, 385, 387, 263, 373, 380]
      [0]   [1]   [2]  [3]   [4]   [5]

é…ç½®:
  [1]     [2]
[0]         [3]
  [5]     [4]
```

**å„ç‚¹ã®æ„å‘³:**
- [0]: å·¦ç«¯
- [1]: ä¸Šéƒ¨å·¦
- [2]: ä¸Šéƒ¨å³
- [3]: å³ç«¯
- [4]: ä¸‹éƒ¨å³
- [5]: ä¸‹éƒ¨å·¦

### **åº§æ¨™ç³»**

- **Xåº§æ¨™**: 0.0ï¼ˆå·¦ï¼‰ ï½ 1.0ï¼ˆå³ï¼‰
- **Yåº§æ¨™**: 0.0ï¼ˆä¸Šï¼‰ ï½ 1.0ï¼ˆä¸‹ï¼‰
- **Zåº§æ¨™**: å¥¥è¡Œãï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

---

## ğŸ”— å‚è€ƒè³‡æ–™

### **å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**
- [MediaPipe Face Mesh](https://google.github.io/mediapipe/solutions/face_mesh.html)
- [MediaPipe Python API](https://google.github.io/mediapipe/solutions/face_mesh.html#python-solution-api)

### **é–¢é€£è«–æ–‡**
- "Real-time Facial Surface Geometry from Monocular Video on Mobile GPUs"
- MediaPipe: A Framework for Building Perception Pipelines

---

## âœ… ã¾ã¨ã‚

### **ç§»è¡Œã®åˆ©ç‚¹**
1. **ç²¾åº¦å‘ä¸Š**: é¡”ãƒ»ç›®æ¤œå‡ºã®ç²¾åº¦ãŒå¤§å¹…ã«å‘ä¸Š
2. **ãƒ­ãƒã‚¹ãƒˆæ€§**: ç…§æ˜ãƒ»è§’åº¦å¤‰åŒ–ã«å¼·ã„
3. **ä½¿ã„ã‚„ã™ã•**: APIãŒã‚·ãƒ³ãƒ—ãƒ«ã§åˆ†ã‹ã‚Šã‚„ã™ã„
4. **äº’æ›æ€§**: æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒæœ€å°é™

### **æ¨å¥¨äº‹é …**
- âœ… æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯MediaPipeç‰ˆã‚’ä½¿ç”¨
- âœ… æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¯æ®µéšçš„ã«ç§»è¡Œ
- âœ… ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ååˆ†ã«æ¤œè¨¼

### **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**
1. ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å‹•ä½œç¢ºèª
2. ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿæ–½
3. ãƒ‡ãƒ¼ã‚¿åé›†ã‚·ã‚¹ãƒ†ãƒ ã®æ›´æ–°
4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¨å®šã‚·ã‚¹ãƒ†ãƒ ã®æ›´æ–°

---

**ç§»è¡Œã¯ç°¡å˜ã§ã€åŠ¹æœã¯çµ¶å¤§ã§ã™ï¼** ğŸš€
